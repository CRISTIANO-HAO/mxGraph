<html>

<head>
  <style type="text/css">
    #main {
      position: absolute;
      left: 0px;
      width: 100%;
      height: 100%;
      right: 0px;
      top: 0px;
      bottom: 0px;
      overflow: hidden;
    }

    .geDiagramContainer {
      height: 100%;
      width: 100%;
    }
  </style>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Init.js"></script>
  <script type="text/javascript" src="../../plugin/mxGraph/jscolor/jscolor.js"></script>
  <script type="text/javascript" src="../../plugin/mxGraph/sanitizer/sanitizer.min.js"></script>
  <script type="text/javascript" src="../../plugin/mxGraph/js/mxClient.js"></script>

  <script type="text/javascript" src="../../plugin/modelgraph/model/EditorUi.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Editor.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Sidebar.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Graph.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Shapes.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Actions.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Menus.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Format.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Toolbar.js"></script>
  <script type="text/javascript" src="../../plugin/modelgraph/model/Dialogs.js"></script>
</head>

<body>
  <div id="main"></div>

  <script type="text/javascript">
    // 请求路径
    let filePath = './xml/model.xml'
    // let filePath = './xml/data.xml'
    // let filePath = './xml/8.xml'
    // let filePath = './xml/9.xml'
    // let filePath = './xml/10.xml'
    // let filePath = './xml/11.xml'
    // 获取graph容器
    let container = document.getElementById('main')
    // 异步加载xml，返回mxXmlRequest对象
    mxUtils.get(filePath, onload, onerror)

    function onload(req) {
      if (req.request.status !== 200) {
        return
      }

      mxResources.loadDefaultBundle = false;
      let bundle = mxResources.getDefaultBundle(RESOURCE_BASE, mxLanguage) || mxResources.getSpecialBundle(
        RESOURCE_BASE, mxLanguage);

      mxUtils.getAll([bundle, STYLE_PATH + '/default.xml'], function (xhr) {
        let themes = new Object();
        themes[Graph.prototype.defaultThemeName] = xhr[1].getDocumentElement();

        // Main
        let editor = new Editor(true, themes);
        editorUI = new EditorUi(editor, container);

        let root = req.getDocumentElement();
        let dec = new mxCodec(root.ownerDocument);
        let model = dec.decode(root, editorUI.editor.graph.getModel());
        let graph = editorUI.editor.graph;

        // 开启提示
        graph.setTooltips(true);

        highlightGraphLine(graph, true)

        addCellCursor(graph)

      }, function () {
        mxLog.show()
        mxLog.warn('url is wrong!')
      });
    }

    // 高亮line
    function highlightGraphLine(graph, toggle) {
      let view = graph.view
      let model = graph.model
      let lastStyle = null
      let lastCell = null
      let cellChild = []

      graph.click = function (evt) {
        // 获取cell
        let cell = evt.getCell()
        addVertex(evt,graph,cell,cellChild)
        if (!cell) {
          return
        }

        if (cell.isEdge()) {
          // resetLinePosition(this, cell)
          setEdgeCellStyle(cell)
        }
      }

      // 设置线路样式
      function setEdgeCellStyle(cell) {
        let style = ''
        // 点击不同cell
        if (lastCell !== cell) {
          // 重置默认样式
          if (lastCell) {
            model.setStyle(lastCell, lastStyle)
          }
          lastCell = cell
          lastStyle = model.getStyle(cell)

          // 需要新变量接收，否则lastStyle会被 mxUtils.setStyle方法改变
          style = getChangeStyle(lastStyle)
          graph.setCellStyle(style, [cell])

        } else if (toggle) { // 重复点击是否需要切换样式
          style = model.getStyle(cell)
          if (style === lastStyle) {
            style = getChangeStyle(lastStyle)
          } else {
            style = lastStyle
          }
          graph.setCellStyle(style, [cell])
        } else {
          // 该api有bug
          // graph.toggleCellStyle(mxConstants.STYLE_STROKECOLOR,'#666',cell)
          // graph.toggleCellStyle(mxConstants.STYLE_STROKEWIDTH,'20',cell)
        }
      }
    }

    // 插入vertex
    function addVertex(evt,graph,cell,cellChild){
      // 删除添加的cell
      graph.removeCells(cellChild)
      // 清空数组
      cellChild.splice(0,cellChild.length)
      // 当cell为edge时才继续
      if(cell === null || cell.isVertex()){
        return
      }
      let { x, y } = getToolTipPosition(evt,graph)
      let child = graph.insertVertex(cell,null,'hello workd', x, y)
      cellChild.push(child)
      graph.refresh()
    }

    // 获取tooltip位置
    function getToolTipPosition(evt,graph){
      let { graphX, graphY}  = evt
      let style = graph.container.children[0]['style']
      let scale = graph.view.getScale()
      return {
        x: graphX/scale - Number(style['left'].slice(0,-2)) * scale,
        y: graphY/scale - Number(style['top'].slice(0,-2)) * scale
      }
    }

    // 重置高亮线路的位置
    function resetLinePosition(graph, cell) {
      let view = graph.view
      let container = graph.container
      let geometry = cell.geometry
      let scale = view.getScale()
      let x, y
      let style = window.getComputedStyle(container)

      if (cell.isEdge()) {
        if (geometry.points.length > 0) {
          let startPoint = geometry.points[0]
          let endPoint = geometry.points[geometry.points.length - 1]
          x = (startPoint.x + endPoint.x) * 0.5
          y = (startPoint.y + endPoint.y) * 0.5
        } else {
          x = geometry.x + geometry.width * 0.5
          y = geometry.y + geometry.height * 0.5
        }
        x = x * scale - Number(style['width'].slice(0, -2)) * 0.5
        y = y * scale - Number(style['height'].slice(0, -2)) * 0.5
      }
      container.scrollLeft = x
      container.scrollTop = y
    }

    // 返回改变的样式
    function getChangeStyle(style) {
      style = mxUtils.setStyle(style, mxConstants.STYLE_STROKECOLOR, 'red');
      style = mxUtils.setStyle(style, mxConstants.STYLE_STROKEWIDTH, "2");
      return style
    }

    // 设置鼠标悬浮形状
    function addCellCursor(graph) {
      let track = new mxCellTracker(graph);
      track.mouseMove = function (sender, evt) {
        // 获取cell
        let cell = evt.getCell()
        if (!cell) {
          return
        }

        // 获取cell对应的mxCellState实例
        let state = evt.getState()
        if (cell.isEdge()) {
          state.setCursor('move');
        } else if (cell.isVertex()) {
          state.setCursor('pointer');
        }
      }
    }
  </script>
</body>

</html>